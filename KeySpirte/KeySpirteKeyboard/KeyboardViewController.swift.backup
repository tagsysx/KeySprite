//
//  KeyboardViewController.swift
//  KeySpirteKeyboard
//
//  Created by Lei Yang on 12/8/2025.
//

import UIKit

class KeyboardViewController: UIInputViewController {

    // ç§»é™¤@IBOutletï¼Œæ”¹ä¸ºæ™®é€šçš„å¯é€‰å±æ€§
    private var nextKeyboardButton: UIButton!
    
    // MARK: - Properties
    private var keyboardView: KeyboardView!
    private var aiPredictor: AIPredictor!
    
    override func updateViewConstraints() {
        super.updateViewConstraints()
        
        // Add custom view sizing constraints here
    }
    
    override func viewDidLoad() {
        super.viewDidLoad()
        
        print("ğŸš€ KeyboardViewController viewDidLoad called")
        print("ğŸ“± View frame: \(view.frame)")
        print("ğŸ“± View bounds: \(view.bounds)")
        print("ğŸ“± View constraints: \(view.constraints.count)")
        
        // åˆå§‹åŒ–AIé¢„æµ‹å™¨
        aiPredictor = AIPredictor()
        
        // åˆå§‹åŒ–å…±äº«æ•°æ®ç®¡ç†å™¨
        setupSharedData()
        
        // è®¾ç½®é”®ç›˜è§†å›¾ - ç§»é™¤å»¶è¿Ÿï¼Œç›´æ¥è®¾ç½®
        setupKeyboardView()
        setupNextKeyboardButton()
        
        print("ğŸ¯ ViewDidLoad setup complete")
    }
    
    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        print("ğŸ“± ViewWillAppear called")
        
        // éªŒè¯è§†å›¾çº¦æŸ
        validateViewConstraints()
        
        // åœ¨è§†å›¾å³å°†æ˜¾ç¤ºæ—¶å¤„ç†nextKeyboardButton
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.2) { [weak self] in
            guard let self = self, self.nextKeyboardButton != nil else { return }
            print("ğŸ”§ Setting nextKeyboardButton visibility in viewWillAppear")
            self.nextKeyboardButton.isHidden = !self.needsInputModeSwitchKey
        }
    }
    
    override func viewDidAppear(_ animated: Bool) {
        super.viewDidAppear(animated)
        print("ğŸ“± ViewDidAppear called")
        
        // å¼ºåˆ¶æ›´æ–°å¸ƒå±€ï¼Œç¡®ä¿è§†å›¾å°ºå¯¸æ­£ç¡®
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) { [weak self] in
            self?.forceLayoutUpdate()
        }
        
        // å¦‚æœè§†å›¾ä»ç„¶æ²¡æœ‰æ­£ç¡®çš„å°ºå¯¸ï¼Œå°è¯•å»¶è¿Ÿå¤„ç†
        if view.frame.width == 0 || view.frame.height == 0 {
            print("âš ï¸ View still has zero frame in viewDidAppear, scheduling delayed layout")
            DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) { [weak self] in
                self?.handleDelayedLayout()
            }
        }
        
        // æ·»åŠ é¢å¤–çš„å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿å¸ƒå±€æœ€ç»ˆæ­£ç¡®
        DispatchQueue.main.asyncAfter(deadline: .now() + 1.0) { [weak self] in
            self?.finalLayoutCheck()
        }
    }
    
    private func finalLayoutCheck() {
        print("ğŸ” Final layout check...")
        
        if view.frame.width > 0 && view.frame.height > 0 {
            print("âœ… Final check: View has proper dimensions")
            if let keyboardView = keyboardView, keyboardView.keyViews.isEmpty {
                print("ğŸ”§ Final check: Creating keyboard layout")
                keyboardView.createKeyboardLayout()
            }
        } else {
            print("âš ï¸ Final check: View still has invalid dimensions")
        }
    }
    
    private func forceLayoutUpdate() {
        print("ğŸ”„ Forcing layout update...")
        view.setNeedsLayout()
        view.layoutIfNeeded()
        
        // å¦‚æœé”®ç›˜è§†å›¾è¿˜æ²¡æœ‰æ­£ç¡®å°ºå¯¸ï¼Œå¼ºåˆ¶æ›´æ–°
        if let keyboardView = keyboardView, keyboardView.frame.width == 0 || keyboardView.frame.height == 0 {
            print("ğŸ”„ Forcing keyboard view layout update...")
            keyboardView.forceUpdate()
        }
    }
    
    private func handleDelayedLayout() {
        print("ğŸ”„ Handling delayed layout...")
        
        // å†æ¬¡æ£€æŸ¥è§†å›¾å°ºå¯¸
        if view.frame.width > 0 && view.frame.height > 0 {
            print("âœ… View now has proper dimensions: \(view.frame)")
            forceLayoutUpdate()
        } else {
            print("âš ï¸ View still has invalid dimensions: \(view.frame)")
            // å°è¯•å¼ºåˆ¶æ›´æ–°çº¦æŸ
            view.setNeedsUpdateConstraints()
            view.updateConstraintsIfNeeded()
            view.setNeedsLayout()
            view.layoutIfNeeded()
            
            // å¦‚æœä»ç„¶æ²¡æœ‰æ­£ç¡®çš„å°ºå¯¸ï¼Œå°è¯•é‡æ–°åˆ›å»ºé”®ç›˜è§†å›¾
            DispatchQueue.main.asyncAfter(deadline: .now() + 1.0) { [weak self] in
                self?.recreateKeyboardViewIfNeeded()
            }
        }
    }
    
    private func recreateKeyboardViewIfNeeded() {
        print("ğŸ”„ Attempting to recreate keyboard view...")
        
        // æ£€æŸ¥å½“å‰çŠ¶æ€
        if view.frame.width == 0 || view.frame.height == 0 {
            print("âš ï¸ View still has invalid dimensions, recreating keyboard view")
            
            // ç§»é™¤ç°æœ‰çš„é”®ç›˜è§†å›¾
            keyboardView?.removeFromSuperview()
            keyboardView = nil
            
            // é‡æ–°åˆ›å»º
            setupKeyboardView()
            setupNextKeyboardButton()
        }
    }
    
    private func validateViewConstraints() {
        print("ğŸ” Validating view constraints...")
        print("ğŸ“± Main view constraints: \(view.constraints.count)")
        print("ğŸ“± Main view frame: \(view.frame)")
        print("ğŸ“± Main view bounds: \(view.bounds)")
        
        if let keyboardView = keyboardView {
            print("ğŸ¹ KeyboardView constraints: \(keyboardView.constraints.count)")
            print("ğŸ¹ KeyboardView frame: \(keyboardView.frame)")
            print("ğŸ¹ KeyboardView bounds: \(keyboardView.bounds)")
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„çº¦æŸ
        if view.constraints.count < 4 {
            print("âš ï¸ Warning: Main view has fewer than 4 constraints")
        }
    }
    
    // MARK: - UI Setup
    
    private func setupKeyboardView() {
        print("ğŸ”§ Setting up keyboard view...")
        
        // åˆ›å»ºé”®ç›˜è§†å›¾
        keyboardView = KeyboardView()
        keyboardView.delegate = self
        keyboardView.translatesAutoresizingMaskIntoConstraints = false
        
        // è®¾ç½®èƒŒæ™¯è‰²ä»¥ä¾¿è°ƒè¯•
        keyboardView.backgroundColor = UIColor.systemBlue.withAlphaComponent(0.3)
        
        // æ·»åŠ åˆ°è§†å›¾å±‚æ¬¡
        view.addSubview(keyboardView)
        
        // è®¾ç½®çº¦æŸ - é”®ç›˜è§†å›¾åº”è¯¥å¡«å……æ•´ä¸ªå¯ç”¨ç©ºé—´
        NSLayoutConstraint.activate([
            keyboardView.topAnchor.constraint(equalTo: view.topAnchor),
            keyboardView.leadingAnchor.constraint(equalTo: view.leadingAnchor),
            keyboardView.trailingAnchor.constraint(equalTo: view.trailingAnchor),
            keyboardView.bottomAnchor.constraint(equalTo: view.bottomAnchor)
        ])
        
        // å¼ºåˆ¶ç«‹å³æ›´æ–°çº¦æŸ
        view.setNeedsUpdateConstraints()
        view.updateConstraintsIfNeeded()
        
        print("âœ… Keyboard view setup complete. Frame: \(keyboardView.frame)")
        print("âœ… View hierarchy: \(view.subviews)")
        print("âœ… View constraints after setup: \(view.constraints.count)")
        print("âœ… KeyboardView constraints: \(keyboardView.constraints.count)")
    }
    
    private func setupNextKeyboardButton() {
        // åˆ›å»ºåˆ‡æ¢é”®ç›˜æŒ‰é’®
        self.nextKeyboardButton = UIButton(type: .system)
        self.nextKeyboardButton.setTitle(NSLocalizedString("ğŸŒ", comment: "Next Keyboard button"), for: [])
        self.nextKeyboardButton.titleLabel?.font = UIFont.systemFont(ofSize: 20)
        self.nextKeyboardButton.backgroundColor = UIColor.systemGray4
        self.nextKeyboardButton.layer.cornerRadius = 8
        self.nextKeyboardButton.translatesAutoresizingMaskIntoConstraints = false
        
        self.nextKeyboardButton.addTarget(self, action: #selector(handleInputModeList(from:with:)), for: .touchUpInside)
        
        // æ·»åŠ åˆ°é”®ç›˜è§†å›¾çš„é¡¶éƒ¨
        view.addSubview(self.nextKeyboardButton)
        
        // è®¾ç½®çº¦æŸ - æ”¾åœ¨å³ä¸Šè§’
        NSLayoutConstraint.activate([
            self.nextKeyboardButton.topAnchor.constraint(equalTo: view.safeAreaLayoutGuide.topAnchor, constant: 8),
            self.nextKeyboardButton.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: -8),
            self.nextKeyboardButton.widthAnchor.constraint(equalToConstant: 44),
            self.nextKeyboardButton.heightAnchor.constraint(equalToConstant: 44)
        ])
    }
    
    override func viewWillLayoutSubviews() {
        super.viewWillLayoutSubviews()
        
        // åœ¨viewWillLayoutSubviewsä¸­ä¸è°ƒç”¨needsInputModeSwitchKey
        // ç­‰å¾…viewDidLayoutSubviewsä¸­å¤„ç†
        print("ğŸ“± ViewWillLayoutSubviews called")
    }
    
    override func viewDidLayoutSubviews() {
        super.viewDidLayoutSubviews()
        
        // åœ¨å¸ƒå±€å®Œæˆåå†æ¬¡æ£€æŸ¥frame
        print("ğŸ“± ViewDidLayoutSubviews - Frame: \(view.frame)")
        print("ğŸ¹ KeyboardView frame: \(keyboardView?.frame ?? .zero)")
        
        // å¦‚æœè§†å›¾æœ‰æœ‰æ•ˆå°ºå¯¸ä¸”é”®ç›˜è§†å›¾è¿˜æ²¡æœ‰å¸ƒå±€ï¼Œåˆ™åˆ›å»ºé”®ç›˜å¸ƒå±€
        if view.frame.width > 0 && view.frame.height > 0 && keyboardView != nil {
            // æ£€æŸ¥é”®ç›˜è§†å›¾æ˜¯å¦å·²ç»æœ‰å†…å®¹ï¼Œé¿å…é‡å¤åˆ›å»º
            if keyboardView.keyViews.isEmpty {
                print("ğŸ”§ Creating keyboard layout in viewDidLayoutSubviews")
                keyboardView.createKeyboardLayout()
            }
        }
        
        // å»¶è¿Ÿè°ƒç”¨needsInputModeSwitchKeyï¼Œé¿å…è¿‡æ—©è°ƒç”¨
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) { [weak self] in
            guard let self = self, self.nextKeyboardButton != nil else { return }
            print("ğŸ”§ Setting nextKeyboardButton visibility after delay")
            self.nextKeyboardButton.isHidden = !self.needsInputModeSwitchKey
        }
    }
    
    override func viewWillTransition(to size: CGSize, with coordinator: UIViewControllerTransitionCoordinator) {
        super.viewWillTransition(to: size, with: coordinator)
        
        // å¤„ç†å±å¹•æ—‹è½¬æˆ–å°ºå¯¸å˜åŒ–
        coordinator.animate { [weak self] _ in
            // å¦‚æœå°ºå¯¸å˜åŒ–å¾ˆå¤§ï¼Œé‡ç½®é”®ç›˜å¸ƒå±€
            if let currentFrame = self?.view.frame,
               abs(currentFrame.width - size.width) > 50 || abs(currentFrame.height - size.height) > 50 {
                print("ğŸ”„ Significant size change detected, resetting keyboard layout")
                self?.keyboardView?.resetLayout()
            }
            
            self?.view.setNeedsLayout()
            self?.view.layoutIfNeeded()
        }
        
        // åœ¨è½¬æ¢å®Œæˆåå†æ¬¡æ£€æŸ¥
        coordinator.animate(alongsideTransition: nil) { [weak self] _ in
            DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) { [weak self] in
                self?.forceLayoutUpdate()
            }
        }
    }
    
    override func viewWillDisappear(_ animated: Bool) {
        super.viewWillDisappear(animated)
        print("ğŸ“± ViewWillDisappear called")
    }
    
    override func viewDidDisappear(_ animated: Bool) {
        super.viewDidDisappear(animated)
        print("ğŸ“± ViewDidDisappear called")
    }
    
    override func textWillChange(_ textInput: UITextInput?) {
        // The app is about to change the document's contents. Perform any preparation here.
    }
    
    override func textDidChange(_ textInput: UITextInput?) {
        // The app has just changed the document's contents, the document context has been updated.
        
        // ç¡®ä¿nextKeyboardButtonå·²ç»åˆå§‹åŒ–
        guard let nextKeyboardButton = self.nextKeyboardButton else { return }
        
        var textColor: UIColor
        let proxy = self.textDocumentProxy
        if proxy.keyboardAppearance == UIKeyboardAppearance.dark {
            textColor = UIColor.white
        } else {
            textColor = UIColor.black
        }
        nextKeyboardButton.setTitleColor(textColor, for: [])
    }
    
    // MARK: - Shared Data Management
    
    private func setupSharedData() {
        // æ”¹è¿›App Groupæ£€æµ‹å’Œä½¿ç”¨
        print("ğŸ”§ Setting up shared data...")
        
        if SharedDataManager.shared.isAppGroupAvailable {
            print("âœ… App Group is available for data sharing")
            
            // è®¾ç½®é»˜è®¤å€¼
            setupDefaultPreferences()
        } else {
            print("âš ï¸ App Group is not available, using local storage")
            // å³ä½¿App Groupä¸å¯ç”¨ï¼Œä¹Ÿè®¾ç½®æœ¬åœ°é»˜è®¤å€¼
            setupDefaultPreferences()
        }
    }
    
    private func setupDefaultPreferences() {
        print("ğŸ”§ Setting up default preferences...")
        
        // å¦‚æœæŸäº›è®¾ç½®è¿˜æ²¡æœ‰å€¼ï¼Œè®¾ç½®é»˜è®¤å€¼
        if SharedDataManager.shared.getUserPreference(forKey: "keyboard_theme") == nil {
            SharedDataManager.shared.saveKeyboardTheme("default")
            print("âœ… Set default keyboard theme")
        }
        
        if SharedDataManager.shared.getUserPreference(forKey: "keyboard_layout") == nil {
            SharedDataManager.shared.saveKeyboardLayout("qwerty")
            print("âœ… Set default keyboard layout")
        }
        
        if SharedDataManager.shared.getUserPreference(forKey: "ai_prediction_enabled") == nil {
            SharedDataManager.shared.saveAIPredictionEnabled(true)
            print("âœ… Set default AI prediction enabled")
        }
        
        print("âœ… Default preferences setup complete")
    }
    
    private func updateLastActiveTime() {
        // å®‰å…¨åœ°æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
        do {
            SharedDataManager.shared.saveLastActiveTime()
            print("âœ… Updated last active time")
        } catch {
            print("âš ï¸ Failed to update last active time: \(error)")
        }
    }
}

// MARK: - KeyboardViewDelegate
extension KeyboardViewController: KeyboardViewDelegate {
    func didTapKey(_ key: KeyboardKey) {
        print("ğŸ”‘ Key tapped: \(key.character)")
        
        // å¤„ç†T9è¾“å…¥ï¼ˆå¦‚æœæ˜¯ä¸­æ–‡å¸ƒå±€ï¼‰
        if let t9Result = keyboardView.handleT9Input(key.character) {
            handleT9Result(t9Result)
            return
        }
        
        // å¤„ç†å…¶ä»–å¸ƒå±€çš„æŒ‰é”®
        switch key.type {
        case .character:
            textDocumentProxy.insertText(key.character)
            
        case .backspace:
            textDocumentProxy.deleteBackward()
            
        case .space:
            textDocumentProxy.insertText(" ")
            
        case .return:
            textDocumentProxy.insertText("\n")
            
        case .shift:
            // å¤„ç†Shifté”®é€»è¾‘
            print("â‡§ Shift key tapped")
            
        case .layout:
            // å¤„ç†å¸ƒå±€åˆ‡æ¢é”®
            handleLayoutKeyTap(key.character)
            
        case .emoji:
            // å¤„ç†è¡¨æƒ…é”®
            print("ğŸ˜€ Emoji key tapped")
        }
    }
    
    func didLongPressKey(_ key: KeyboardKey) {
        print("ğŸ”‘ Key long pressed: \(key.character)")
        
        // å¤„ç†é•¿æŒ‰é€»è¾‘
        switch key.type {
        case .backspace:
            // é•¿æŒ‰åˆ é™¤é”®å¯ä»¥è¿ç»­åˆ é™¤
            textDocumentProxy.deleteBackward()
            
        case .space:
            // é•¿æŒ‰ç©ºæ ¼é”®å¯ä»¥è¿ç»­æ’å…¥ç©ºæ ¼
            textDocumentProxy.insertText(" ")
            
        default:
            break
        }
    }
    
    func didTapLayoutButton(_ layout: KeyboardLayout) {
        print("ğŸ¯ Layout button tapped: \(layout)")
        
        // æ›´æ–°é”®ç›˜å¸ƒå±€
        keyboardView.updateLayout(layout)
        
        // ä¿å­˜ç”¨æˆ·åå¥½
        SharedDataManager.shared.saveKeyboardLayout(layout.rawValue)
    }
    
    // MARK: - T9 Input Handling
    
    private func handleT9Result(_ result: T9InputResult) {
        switch result {
        case .candidate(let word):
            // æ˜¾ç¤ºå€™é€‰è¯
            print("ğŸ“ T9 candidate: \(word)")
            // è¿™é‡Œå¯ä»¥æ›´æ–°å€™é€‰è¯æ˜¾ç¤º
            
        case .input(let text):
            // æ’å…¥æ–‡æœ¬
            textDocumentProxy.insertText(text)
            print("ğŸ“ T9 input: \(text)")
        case .confirmed(let word):
            // ç¡®è®¤è¾“å…¥
            textDocumentProxy.insertText(word)
            print("ğŸ“ T9 confirmed: \(word)")
        case .space:
            // æ’å…¥ç©ºæ ¼
            textDocumentProxy.insertText(" ")
            print("ğŸ“ T9 space")
        case .cleared:
            print("ğŸ“ T9 cleared")
        case .none:
            print("ğŸ“ T9 none")
        }
    }
    
    private func handleLayoutKeyTap(_ key: String) {
        print("ğŸ¯ Layout key tapped: \(key)")
        
        // æ ¹æ®æŒ‰é”®åˆ‡æ¢å¸ƒå±€
        switch key {
        case "123":
            keyboardView.updateLayout(.number)
        case "ABC":
            keyboardView.updateLayout(.qwerty)
        case "ğŸŒ":
            // åˆ‡æ¢é”®ç›˜
            advanceToNextInputMode()
        case "ğŸ˜€":
            keyboardView.updateLayout(.emoji)
        case "Symbols":
            keyboardView.updateLayout(.symbol)
        default:
            break
        }
    }
    
    // MARK: - Background Handling
    
    // MARK: - AI Prediction
    
    private func handleAIPrediction() {
        // è¿™é‡Œå¯ä»¥æ·»åŠ AIé¢„æµ‹é€»è¾‘
        print("ğŸ¤– AI prediction handling...")
    }
    
    // MARK: - Memory Management
    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        print("âš ï¸ Memory warning received")
        
        // æ¸…ç†ä¸å¿…è¦çš„èµ„æº
        if let keyboardView = keyboardView {
            keyboardView.resetLayout()
        }
    }
    
    deinit {
        print("ğŸ“± KeyboardViewController deallocated")
    }
}
